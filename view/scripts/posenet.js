// Copyright (c) 2019 ml5
//
// This software is released under the MIT License.
// https://opensource.org/licenses/MIT

/* ===
ml5 Example
PoseNet example using p5.js
=== */
let score = 0;
let data = JSON.parse(`{
  "cqcw":[
      {
          "filename":"assets/images/cqcw1.png",
              "pose":{
                  "score":0.6935193415950326,
                  "keypoints":[
                      {
                          "score":0.999488353729248,
                          "part":"nose",
                          "position":{
                              "x":168.9755980731451,
                              "y":153.11197351526332
                          }
                      },
                      {
                          "score":0.9998165369033813,
                          "part":"leftEye",
                          "position":{
                              "x":186.12424610279226,
                              "y":139.67471560353655
                          }
                      },
                      {
                          "score":0.9986909031867981,
                          "part":"rightEye",
                          "position":{
                              "x":161.4415420621459,
                              "y":139.86521557664778
                          }
                      },
                      {
                          "score":0.9851713180541992,
                          "part":"leftEar",
                          "position":{
                              "x":214.83405695091676,
                              "y":150.31000166329724
                          }
                      },
                      {
                          "score":0.1847723126411438,
                          "part":"rightEar",
                          "position":{
                              "x":152.35884573120356,
                              "y":147.50179887143258
                          }
                      },
                      {
                          "score":0.98064786195755,
                          "part":"leftShoulder",
                          "position":{
                              "x":205.0928635625114,
                              "y":214.219461957846
                          }
                      },
                      {
                          "score":0.6614201068878174,
                          "part":"rightShoulder",
                          "position":{
                              "x":190.31320000066626,
                              "y":200.45124043544598
                          }
                      },
                      {
                          "score":0.7737113833427429,
                          "part":"leftElbow",
                          "position":{
                              "x":183.29930159362436,
                              "y":264.09980372378703
                          }
                      },
                      {
                          "score":0.621453046798706,
                          "part":"rightElbow",
                          "position":{
                              "x":182.94371318259434,
                              "y":270.79957464563915
                          }
                      },
                      {
                          "score":0.917769193649292,
                          "part":"leftWrist",
                          "position":{
                              "x":149.70153868082207,
                              "y":290.97649093538695
                          }
                      },
                      {
                          "score":0.7681432366371155,
                          "part":"rightWrist",
                          "position":{
                              "x":101.01490968105622,
                              "y":44.758107934546516
                          }
                      },
                      {
                          "score":0.4359235465526581,
                          "part":"leftHip",
                          "position":{
                              "x":265.730010450932,
                              "y":314.4522807993155
                          }
                      },
                      {
                          "score":0.3307599127292633,
                          "part":"rightHip",
                          "position":{
                              "x":237.81744521589076,
                              "y":318.82954754745754
                          }
                      },
                      {
                          "score":0.6674386858940125,
                          "part":"leftKnee",
                          "position":{
                              "x":162.1524199249684,
                              "y":344.1226004736233
                          }
                      },
                      {
                          "score":0.5401540398597717,
                          "part":"rightKnee",
                          "position":{
                              "x":154.92390025475336,
                              "y":344.3826006021184
                          }
                      },
                      {
                          "score":0.4254053831100464,
                          "part":"leftAnkle",
                          "position":{
                              "x":157.39479835316916,
                              "y":449.8204885858309
                          }
                      },
                      {
                          "score":0.49906298518180847,
                          "part":"rightAnkle",
                          "position":{
                              "x":160.04784130074128,
                              "y":444.7961481700399
                          }
                      }
                  ],
                  "nose":{
                      "x":168.9755980731451,
                      "y":153.11197351526332,
                      "confidence":0.999488353729248
                  },
                  "leftEye":{
                      "x":186.12424610279226,
                      "y":139.67471560353655,
                      "confidence":0.9998165369033813
                  },
                  "rightEye":{
                      "x":161.4415420621459,
                      "y":139.86521557664778,
                      "confidence":0.9986909031867981
                  },
                  "leftEar":{
                      "x":214.83405695091676,
                      "y":150.31000166329724,
                      "confidence":0.9851713180541992
                  },
                  "rightEar":{
                      "x":152.35884573120356,
                      "y":147.50179887143258,
                      "confidence":0.1847723126411438
                  },
                  "leftShoulder":{
                      "x":205.0928635625114,
                      "y":214.219461957846,
                      "confidence":0.98064786195755
                  },
                  "rightShoulder":{
                      "x":190.31320000066626,
                      "y":200.45124043544598,
                      "confidence":0.6614201068878174
                  },
                  "leftElbow":{
                      "x":183.29930159362436,
                      "y":264.09980372378703,
                      "confidence":0.7737113833427429
                  },
                  "rightElbow":{
                      "x":182.94371318259434,
                      "y":270.79957464563915,
                      "confidence":0.621453046798706
                  },
                  "leftWrist":{
                      "x":149.70153868082207,
                      "y":290.97649093538695,
                      "confidence":0.917769193649292
                  },
                  "rightWrist":{
                      "x":101.01490968105622,
                      "y":44.758107934546516,
                      "confidence":0.7681432366371155
                  },
                  "leftHip":{
                      "x":265.730010450932,
                      "y":314.4522807993155,
                      "confidence":0.4359235465526581
                  },
                  "rightHip":{
                      "x":237.81744521589076,
                      "y":318.82954754745754,
                      "confidence":0.3307599127292633
                  },
                  "leftKnee":{
                      "x":162.1524199249684,
                      "y":344.1226004736233,
                      "confidence":0.6674386858940125
                  },
                  "rightKnee":{
                      "x":154.92390025475336,
                      "y":344.3826006021184,
                      "confidence":0.5401540398597717
                  },
                  "leftAnkle":{
                      "x":157.39479835316916,
                      "y":449.8204885858309,
                      "confidence":0.4254053831100464
                  },
                  "rightAnkle":{
                      "x":160.04784130074128,
                      "y":444.7961481700399,
                      "confidence":0.49906298518180847
                  }
              },
              "skeleton":[
                  [
                      {
                          "score":0.4359235465526581,
                          "part":"leftHip",
                          "position":{
                              "x":265.730010450932,
                              "y":314.4522807993155
                          }
                      },
                      {
                          "score":0.98064786195755,
                          "part":"leftShoulder",
                          "position":{
                              "x":205.0928635625114,
                              "y":214.219461957846
                          }
                      }
                  ],
                  [
                      {
                          "score":0.7737113833427429,
                          "part":"leftElbow",
                          "position":{
                              "x":183.29930159362436,
                              "y":264.09980372378703
                          }
                      },
                      {
                          "score":0.98064786195755,
                          "part":"leftShoulder",
                          "position":{
                              "x":205.0928635625114,
                              "y":214.219461957846
                          }
                      }
                  ],
                  [
                      {
                          "score":0.7737113833427429,
                          "part":"leftElbow",
                          "position":{
                              "x":183.29930159362436,
                              "y":264.09980372378703
                          }
                      },
                      {
                          "score":0.917769193649292,
                          "part":"leftWrist",
                          "position":{
                              "x":149.70153868082207,
                              "y":290.97649093538695
                          }
                      }
                  ],
                  [
                      {
                          "score":0.4359235465526581,
                          "part":"leftHip",
                          "position":{
                              "x":265.730010450932,
                              "y":314.4522807993155
                          }
                      },
                      {
                          "score":0.6674386858940125,
                          "part":"leftKnee",
                          "position":{
                              "x":162.1524199249684,
                              "y":344.1226004736233
                          }
                      }
                  ],
                  [
                      {
                          "score":0.6674386858940125,
                          "part":"leftKnee",
                          "position":{
                              "x":162.1524199249684,
                              "y":344.1226004736233
                          }
                      },
                      {
                          "score":0.4254053831100464,
                          "part":"leftAnkle",
                          "position":{
                              "x":157.39479835316916,
                              "y":449.8204885858309
                          }
                      }
                  ],
                  [
                      {
                          "score":0.3307599127292633,
                          "part":"rightHip",
                          "position":{
                              "x":237.81744521589076,
                              "y":318.82954754745754
                          }
                      },
                      {
                          "score":0.6614201068878174,
                          "part":"rightShoulder",
                          "position":{
                              "x":190.31320000066626,
                              "y":200.45124043544598
                          }
                      }
                  ],
                  [
                      {
                          "score":0.621453046798706,
                          "part":"rightElbow",
                          "position":{
                              "x":182.94371318259434,
                              "y":270.79957464563915
                          }
                      },
                      {
                          "score":0.6614201068878174,
                          "part":"rightShoulder",
                          "position":{
                              "x":190.31320000066626,
                              "y":200.45124043544598
                          }
                      }
                  ],
                  [
                      {
                          "score":0.621453046798706,
                          "part":"rightElbow",
                          "position":{
                              "x":182.94371318259434,
                              "y":270.79957464563915
                          }
                      },
                      {
                          "score":0.7681432366371155,
                          "part":"rightWrist",
                          "position":{
                              "x":101.01490968105622,
                              "y":44.758107934546516
                          }
                      }
                  ],
                  [
                      {
                          "score":0.3307599127292633,
                          "part":"rightHip",
                          "position":{
                              "x":237.81744521589076,
                              "y":318.82954754745754
                          }
                      },
                      {
                          "score":0.5401540398597717,
                          "part":"rightKnee",
                          "position":{
                              "x":154.92390025475336,
                              "y":344.3826006021184
                          }
                      }
                  ],
                  [
                      {
                          "score":0.5401540398597717,
                          "part":"rightKnee",
                          "position":{
                              "x":154.92390025475336,
                              "y":344.3826006021184
                          }
                      },
                      {
                          "score":0.49906298518180847,
                          "part":"rightAnkle",
                          "position":{
                              "x":160.04784130074128,
                              "y":444.7961481700399
                          }
                      }
                  ],
                  [
                      {
                          "score":0.98064786195755,
                          "part":"leftShoulder",
                          "position":{
                              "x":205.0928635625114,
                              "y":214.219461957846
                          }
                      },
                      {
                          "score":0.6614201068878174,
                          "part":"rightShoulder",
                          "position":{
                              "x":190.31320000066626,
                              "y":200.45124043544598
                          }
                      }
                  ],
                  [
                      {
                          "score":0.4359235465526581,
                          "part":"leftHip",
                          "position":{
                              "x":265.730010450932,
                              "y":314.4522807993155
                          }
                      },
                      {
                          "score":0.3307599127292633,
                          "part":"rightHip",
                          "position":{
                              "x":237.81744521589076,
                              "y":318.82954754745754
                          }
                      }
                  ]
              ]
          
      },
      {
          "filename": "assets/images/cqcw2.png",
          "pose":{
              "score":0.7635943179621416,
              "keypoints":[
                  {
                      "score":0.9988601207733154,
                      "part":"nose",
                      "position":{
                          "x":334.9005098398666,
                          "y":114.98757809644553
                      }
                  },
                  {
                      "score":0.9993902444839478,
                      "part":"leftEye",
                      "position":{
                          "x":357.844910738761,
                          "y":100.43453802514028
                      }
                  },
                  {
                      "score":0.9971888661384583,
                      "part":"rightEye",
                      "position":{
                          "x":329.7300654182657,
                          "y":91.92018357959174
                      }
                  },
                  {
                      "score":0.9820823073387146,
                      "part":"leftEar",
                      "position":{
                          "x":399.27591317160085,
                          "y":113.42556685360319
                      }
                  },
                  {
                      "score":0.10539992153644562,
                      "part":"rightEar",
                      "position":{
                          "x":320.16245773940057,
                          "y":92.2055350707056
                      }
                  },
                  {
                      "score":0.9626166224479675,
                      "part":"leftShoulder",
                      "position":{
                          "x":436.1320672286184,
                          "y":170.22653921026932
                      }
                  },
                  {
                      "score":0.9777727723121643,
                      "part":"rightShoulder",
                      "position":{
                          "x":305.900344224004,
                          "y":187.323310361271
                      }
                  },
                  {
                      "score":0.5689128637313843,
                      "part":"leftElbow",
                      "position":{
                          "x":542.5467179504751,
                          "y":136.16864459835298
                      }
                  },
                  {
                      "score":0.6957451105117798,
                      "part":"rightElbow",
                      "position":{
                          "x":235.7953152126736,
                          "y":210.34576885974428
                      }
                  },
                  {
                      "score":0.8277470469474792,
                      "part":"leftWrist",
                      "position":{
                          "x":613.7109846148575,
                          "y":117.56650128280907
                      }
                  },
                  {
                      "score":0.8394080996513367,
                      "part":"rightWrist",
                      "position":{
                          "x":167.55590748926352,
                          "y":183.7523533038461
                      }
                  },
                  {
                      "score":0.6328770518302917,
                      "part":"leftHip",
                      "position":{
                          "x":353.9182000411184,
                          "y":323.8933549847519
                      }
                  },
                  {
                      "score":0.7755672335624695,
                      "part":"rightHip",
                      "position":{
                          "x":294.99963236133954,
                          "y":312.92573235048883
                      }
                  },
                  {
                      "score":0.8952385187149048,
                      "part":"leftKnee",
                      "position":{
                          "x":381.38571506076386,
                          "y":397.3841346904316
                      }
                  },
                  {
                      "score":0.5004175305366516,
                      "part":"rightKnee",
                      "position":{
                          "x":387.7381184895833,
                          "y":402.5561201010066
                      }
                  },
                  {
                      "score":0.7279514074325562,
                      "part":"leftAnkle",
                      "position":{
                          "x":329.991883395011,
                          "y":485.4948039212886
                      }
                  },
                  {
                      "score":0.4939276874065399,
                      "part":"rightAnkle",
                      "position":{
                          "x":338.43529059872986,
                          "y":488.76718264574197
                      }
                  }
              ],
              "nose":{
                  "x":334.9005098398666,
                  "y":114.98757809644553,
                  "confidence":0.9988601207733154
              },
              "leftEye":{
                  "x":357.844910738761,
                  "y":100.43453802514028,
                  "confidence":0.9993902444839478
              },
              "rightEye":{
                  "x":329.7300654182657,
                  "y":91.92018357959174,
                  "confidence":0.9971888661384583
              },
              "leftEar":{
                  "x":399.27591317160085,
                  "y":113.42556685360319,
                  "confidence":0.9820823073387146
              },
              "rightEar":{
                  "x":320.16245773940057,
                  "y":92.2055350707056,
                  "confidence":0.10539992153644562
              },
              "leftShoulder":{
                  "x":436.1320672286184,
                  "y":170.22653921026932,
                  "confidence":0.9626166224479675
              },
              "rightShoulder":{
                  "x":305.900344224004,
                  "y":187.323310361271,
                  "confidence":0.9777727723121643
              },
              "leftElbow":{
                  "x":542.5467179504751,
                  "y":136.16864459835298,
                  "confidence":0.5689128637313843
              },
              "rightElbow":{
                  "x":235.7953152126736,
                  "y":210.34576885974428,
                  "confidence":0.6957451105117798
              },
              "leftWrist":{
                  "x":613.7109846148575,
                  "y":117.56650128280907,
                  "confidence":0.8277470469474792
              },
              "rightWrist":{
                  "x":167.55590748926352,
                  "y":183.7523533038461,
                  "confidence":0.8394080996513367
              },
              "leftHip":{
                  "x":353.9182000411184,
                  "y":323.8933549847519,
                  "confidence":0.6328770518302917
              },
              "rightHip":{
                  "x":294.99963236133954,
                  "y":312.92573235048883,
                  "confidence":0.7755672335624695
              },
              "leftKnee":{
                  "x":381.38571506076386,
                  "y":397.3841346904316,
                  "confidence":0.8952385187149048
              },
              "rightKnee":{
                  "x":387.7381184895833,
                  "y":402.5561201010066,
                  "confidence":0.5004175305366516
              },
              "leftAnkle":{
                  "x":329.991883395011,
                  "y":485.4948039212886,
                  "confidence":0.7279514074325562
              },
              "rightAnkle":{
                  "x":338.43529059872986,
                  "y":488.76718264574197,
                  "confidence":0.4939276874065399
              }
          },
          "skeleton":[
              [
                  {
                      "score":0.6328770518302917,
                      "part":"leftHip",
                      "position":{
                          "x":353.9182000411184,
                          "y":323.8933549847519
                      }
                  },
                  {
                      "score":0.9626166224479675,
                      "part":"leftShoulder",
                      "position":{
                          "x":436.1320672286184,
                          "y":170.22653921026932
                      }
                  }
              ],
              [
                  {
                      "score":0.5689128637313843,
                      "part":"leftElbow",
                      "position":{
                          "x":542.5467179504751,
                          "y":136.16864459835298
                      }
                  },
                  {
                      "score":0.9626166224479675,
                      "part":"leftShoulder",
                      "position":{
                          "x":436.1320672286184,
                          "y":170.22653921026932
                      }
                  }
              ],
              [
                  {
                      "score":0.5689128637313843,
                      "part":"leftElbow",
                      "position":{
                          "x":542.5467179504751,
                          "y":136.16864459835298
                      }
                  },
                  {
                      "score":0.8277470469474792,
                      "part":"leftWrist",
                      "position":{
                          "x":613.7109846148575,
                          "y":117.56650128280907
                      }
                  }
              ],
              [
                  {
                      "score":0.6328770518302917,
                      "part":"leftHip",
                      "position":{
                          "x":353.9182000411184,
                          "y":323.8933549847519
                      }
                  },
                  {
                      "score":0.8952385187149048,
                      "part":"leftKnee",
                      "position":{
                          "x":381.38571506076386,
                          "y":397.3841346904316
                      }
                  }
              ],
              [
                  {
                      "score":0.8952385187149048,
                      "part":"leftKnee",
                      "position":{
                          "x":381.38571506076386,
                          "y":397.3841346904316
                      }
                  },
                  {
                      "score":0.7279514074325562,
                      "part":"leftAnkle",
                      "position":{
                          "x":329.991883395011,
                          "y":485.4948039212886
                      }
                  }
              ],
              [
                  {
                      "score":0.7755672335624695,
                      "part":"rightHip",
                      "position":{
                          "x":294.99963236133954,
                          "y":312.92573235048883
                      }
                  },
                  {
                      "score":0.9777727723121643,
                      "part":"rightShoulder",
                      "position":{
                          "x":305.900344224004,
                          "y":187.323310361271
                      }
                  }
              ],
              [
                  {
                      "score":0.6957451105117798,
                      "part":"rightElbow",
                      "position":{
                          "x":235.7953152126736,
                          "y":210.34576885974428
                      }
                  },
                  {
                      "score":0.9777727723121643,
                      "part":"rightShoulder",
                      "position":{
                          "x":305.900344224004,
                          "y":187.323310361271
                      }
                  }
              ],
              [
                  {
                      "score":0.6957451105117798,
                      "part":"rightElbow",
                      "position":{
                          "x":235.7953152126736,
                          "y":210.34576885974428
                      }
                  },
                  {
                      "score":0.8394080996513367,
                      "part":"rightWrist",
                      "position":{
                          "x":167.55590748926352,
                          "y":183.7523533038461
                      }
                  }
              ],
              [
                  {
                      "score":0.7755672335624695,
                      "part":"rightHip",
                      "position":{
                          "x":294.99963236133954,
                          "y":312.92573235048883
                      }
                  },
                  {
                      "score":0.5004175305366516,
                      "part":"rightKnee",
                      "position":{
                          "x":387.7381184895833,
                          "y":402.5561201010066
                      }
                  }
              ],
              [
                  {
                      "score":0.5004175305366516,
                      "part":"rightKnee",
                      "position":{
                          "x":387.7381184895833,
                          "y":402.5561201010066
                      }
                  },
                  {
                      "score":0.4939276874065399,
                      "part":"rightAnkle",
                      "position":{
                          "x":338.43529059872986,
                          "y":488.76718264574197
                      }
                  }
              ],
              [
                  {
                      "score":0.9626166224479675,
                      "part":"leftShoulder",
                      "position":{
                          "x":436.1320672286184,
                          "y":170.22653921026932
                      }
                  },
                  {
                      "score":0.9777727723121643,
                      "part":"rightShoulder",
                      "position":{
                          "x":305.900344224004,
                          "y":187.323310361271
                      }
                  }
              ],
              [
                  {
                      "score":0.6328770518302917,
                      "part":"leftHip",
                      "position":{
                          "x":353.9182000411184,
                          "y":323.8933549847519
                      }
                  },
                  {
                      "score":0.7755672335624695,
                      "part":"rightHip",
                      "position":{
                          "x":294.99963236133954,
                          "y":312.92573235048883
                      }
                  }
              ]
          ]
      },
      {
          "filename": "assets/images/cqcw3.png",
          "pose":{
              "score":0.3943135593743885,
              "keypoints":[
                  {
                      "score":0.41788485646247864,
                      "part":"nose",
                      "position":{
                          "x":330.7928044428835,
                          "y":229.42413181356983
                      }
                  },
                  {
                      "score":0.11398251354694366,
                      "part":"leftEye",
                      "position":{
                          "x":194.8652497825102,
                          "y":265.5538155182063
                      }
                  },
                  {
                      "score":0.21156856417655945,
                      "part":"rightEye",
                      "position":{
                          "x":187.19806372213085,
                          "y":264.12918061076084
                      }
                  },
                  {
                      "score":0.2419106811285019,
                      "part":"leftEar",
                      "position":{
                          "x":300.9346093369274,
                          "y":205.95998886733028
                      }
                  },
                  {
                      "score":0.9367842674255371,
                      "part":"rightEar",
                      "position":{
                          "x":311.52060394584555,
                          "y":206.9282371119449
                      }
                  },
                  {
                      "score":0.4357457458972931,
                      "part":"leftShoulder",
                      "position":{
                          "x":279.91787463926204,
                          "y":264.5262270921852
                      }
                  },
                  {
                      "score":0.4189009964466095,
                      "part":"rightShoulder",
                      "position":{
                          "x":238.53087819714762,
                          "y":226.9975368507192
                      }
                  },
                  {
                      "score":0.3040882647037506,
                      "part":"leftElbow",
                      "position":{
                          "x":312.3476179394341,
                          "y":467.9357645432619
                      }
                  },
                  {
                      "score":0.5511560440063477,
                      "part":"rightElbow",
                      "position":{
                          "x":244.929916649534,
                          "y":164.59482397484732
                      }
                  },
                  {
                      "score":0.6390212178230286,
                      "part":"leftWrist",
                      "position":{
                          "x":276.518302337468,
                          "y":66.93802697849088
                      }
                  },
                  {
                      "score":0.6431959867477417,
                      "part":"rightWrist",
                      "position":{
                          "x":277.8390600490756,
                          "y":65.20674231456734
                      }
                  },
                  {
                      "score":0.23635509610176086,
                      "part":"leftHip",
                      "position":{
                          "x":242.6352406998127,
                          "y":354.46624607138233
                      }
                  },
                  {
                      "score":0.07715108245611191,
                      "part":"rightHip",
                      "position":{
                          "x":188.04756958721674,
                          "y":364.9974729303728
                      }
                  },
                  {
                      "score":0.16825348138809204,
                      "part":"leftKnee",
                      "position":{
                          "x":179.06540030020255,
                          "y":398.7371808325338
                      }
                  },
                  {
                      "score":0.22691485285758972,
                      "part":"rightKnee",
                      "position":{
                          "x":152.29753109818546,
                          "y":398.23610837464213
                      }
                  },
                  {
                      "score":0.5331207513809204,
                      "part":"leftAnkle",
                      "position":{
                          "x":456.1007108632584,
                          "y":477.37271879616304
                      }
                  },
                  {
                      "score":0.5472961068153381,
                      "part":"rightAnkle",
                      "position":{
                          "x":456.57832642791334,
                          "y":478.8717684085839
                      }
                  }
              ],
              "nose":{
                  "x":330.7928044428835,
                  "y":229.42413181356983,
                  "confidence":0.41788485646247864
              },
              "leftEye":{
                  "x":194.8652497825102,
                  "y":265.5538155182063,
                  "confidence":0.11398251354694366
              },
              "rightEye":{
                  "x":187.19806372213085,
                  "y":264.12918061076084,
                  "confidence":0.21156856417655945
              },
              "leftEar":{
                  "x":300.9346093369274,
                  "y":205.95998886733028,
                  "confidence":0.2419106811285019
              },
              "rightEar":{
                  "x":311.52060394584555,
                  "y":206.9282371119449,
                  "confidence":0.9367842674255371
              },
              "leftShoulder":{
                  "x":279.91787463926204,
                  "y":264.5262270921852,
                  "confidence":0.4357457458972931
              },
              "rightShoulder":{
                  "x":238.53087819714762,
                  "y":226.9975368507192,
                  "confidence":0.4189009964466095
              },
              "leftElbow":{
                  "x":312.3476179394341,
                  "y":467.9357645432619,
                  "confidence":0.3040882647037506
              },
              "rightElbow":{
                  "x":244.929916649534,
                  "y":164.59482397484732,
                  "confidence":0.5511560440063477
              },
              "leftWrist":{
                  "x":276.518302337468,
                  "y":66.93802697849088,
                  "confidence":0.6390212178230286
              },
              "rightWrist":{
                  "x":277.8390600490756,
                  "y":65.20674231456734,
                  "confidence":0.6431959867477417
              },
              "leftHip":{
                  "x":242.6352406998127,
                  "y":354.46624607138233,
                  "confidence":0.23635509610176086
              },
              "rightHip":{
                  "x":188.04756958721674,
                  "y":364.9974729303728,
                  "confidence":0.07715108245611191
              },
              "leftKnee":{
                  "x":179.06540030020255,
                  "y":398.7371808325338,
                  "confidence":0.16825348138809204
              },
              "rightKnee":{
                  "x":152.29753109818546,
                  "y":398.23610837464213,
                  "confidence":0.22691485285758972
              },
              "leftAnkle":{
                  "x":456.1007108632584,
                  "y":477.37271879616304,
                  "confidence":0.5331207513809204
              },
              "rightAnkle":{
                  "x":456.57832642791334,
                  "y":478.8717684085839,
                  "confidence":0.5472961068153381
              }
          },
          "skeleton":[
              [
                  {
                      "score":0.23635509610176086,
                      "part":"leftHip",
                      "position":{
                          "x":242.6352406998127,
                          "y":354.46624607138233
                      }
                  },
                  {
                      "score":0.4357457458972931,
                      "part":"leftShoulder",
                      "position":{
                          "x":279.91787463926204,
                          "y":264.5262270921852
                      }
                  }
              ],
              [
                  {
                      "score":0.3040882647037506,
                      "part":"leftElbow",
                      "position":{
                          "x":312.3476179394341,
                          "y":467.9357645432619
                      }
                  },
                  {
                      "score":0.4357457458972931,
                      "part":"leftShoulder",
                      "position":{
                          "x":279.91787463926204,
                          "y":264.5262270921852
                      }
                  }
              ],
              [
                  {
                      "score":0.3040882647037506,
                      "part":"leftElbow",
                      "position":{
                          "x":312.3476179394341,
                          "y":467.9357645432619
                      }
                  },
                  {
                      "score":0.6390212178230286,
                      "part":"leftWrist",
                      "position":{
                          "x":276.518302337468,
                          "y":66.93802697849088
                      }
                  }
              ],
              [
                  {
                      "score":0.23635509610176086,
                      "part":"leftHip",
                      "position":{
                          "x":242.6352406998127,
                          "y":354.46624607138233
                      }
                  },
                  {
                      "score":0.16825348138809204,
                      "part":"leftKnee",
                      "position":{
                          "x":179.06540030020255,
                          "y":398.7371808325338
                      }
                  }
              ],
              [
                  {
                      "score":0.16825348138809204,
                      "part":"leftKnee",
                      "position":{
                          "x":179.06540030020255,
                          "y":398.7371808325338
                      }
                  },
                  {
                      "score":0.5331207513809204,
                      "part":"leftAnkle",
                      "position":{
                          "x":456.1007108632584,
                          "y":477.37271879616304
                      }
                  }
              ],
              [
                  {
                      "score":0.5511560440063477,
                      "part":"rightElbow",
                      "position":{
                          "x":244.929916649534,
                          "y":164.59482397484732
                      }
                  },
                  {
                      "score":0.4189009964466095,
                      "part":"rightShoulder",
                      "position":{
                          "x":238.53087819714762,
                          "y":226.9975368507192
                      }
                  }
              ],
              [
                  {
                      "score":0.5511560440063477,
                      "part":"rightElbow",
                      "position":{
                          "x":244.929916649534,
                          "y":164.59482397484732
                      }
                  },
                  {
                      "score":0.6431959867477417,
                      "part":"rightWrist",
                      "position":{
                          "x":277.8390600490756,
                          "y":65.20674231456734
                      }
                  }
              ],
              [
                  {
                      "score":0.22691485285758972,
                      "part":"rightKnee",
                      "position":{
                          "x":152.29753109818546,
                          "y":398.23610837464213
                      }
                  },
                  {
                      "score":0.5472961068153381,
                      "part":"rightAnkle",
                      "position":{
                          "x":456.57832642791334,
                          "y":478.8717684085839
                      }
                  }
              ],
              [
                  {
                      "score":0.4357457458972931,
                      "part":"leftShoulder",
                      "position":{
                          "x":279.91787463926204,
                          "y":264.5262270921852
                      }
                  },
                  {
                      "score":0.4189009964466095,
                      "part":"rightShoulder",
                      "position":{
                          "x":238.53087819714762,
                          "y":226.9975368507192
                      }
                  }
              ]
          ]
      }
  ]
}`)
// config
let {scale, rotate, translate, compose, applyToPoints} = window.TransformationMatrix;
let idx = 0;
let example;
let exPoseData;
let video;
let poseNet;
let poses = [];
let userPoseData;
let isSimilar = false;
let options = {
    architecture: 'ResNet50',
    outputStride: 32,
    inputResolution: { width: 257, height: 200 },
    quantBytes: 2
}
let confidenceLevelThreshold = 0.5;
let minFeaturesThreshold = 10;
let featureList = [
    "Nose",
    "leftEye",
    "rightEye",
    "leftEar",
    "rightEar",
    "leftShoulder",
    "rightShoulder",
    "leftElbow",
    "rightElbow",
    "leftWrist",
    "rightWrist",
    "leftHip",
    "rightHip",
    "leftKnee",
    "rightKnee",
    "leftAnkle",
    "rightAnkle"
]

let faceFeatureList = [
    "Nose",
    "leftEye",
    "rightEye",
    "leftEar",
    "rightEar"
]

let torsoFeatureList = [
    "leftShoulder",
    "rightShoulder",
    "leftElbow",
    "rightElbow",
    "leftWrist",
    "rightWrist"
]

let legsFeatureList = [
    "leftHip",
    "rightHip",
    "leftKnee",
    "rightKnee",
    "leftAnkle",
    "rightAnkle"
]

function standardization(features){
    // min max scale
    const {MinMaxScaler} = ml.preprocessing;
    const scalerX = new MinMaxScaler({featureRange: [0, 1]});
    const scalerY = new MinMaxScaler({featureRange: [0, 1]});

    const X = features.map((arr) => {return arr[0]});
    const Y = features.map((arr) => {return arr[1]});

    const scaledX = scalerX.fit_transform(X);
    const scaledY = scalerY.fit_transform(Y);
    const scaledFeatures = scaledX.map((_, i) => {return [scaledX[i], scaledY[i]]});

    return scaledFeatures;
}

function removeUnqualifiedKeypoints(modelFeaturesObj, userFeaturesObj){
    let qualifiedFeatures = [];
    let modelArr = [];
    let userArr = [];

    for(var i=0; i<featureList.length; i++){
        if(!(modelFeaturesObj.keypoints[i].score < confidenceLevelThreshold ||
            userFeaturesObj.keypoints[i].score < confidenceLevelThreshold)){
            
                qualifiedFeatures.push(featureList[i]);

                modelArr.push([modelFeaturesObj.keypoints[i].position.x, modelFeaturesObj.keypoints[i].position.y]);
                userArr.push([userFeaturesObj.keypoints[i].position.x, userFeaturesObj.keypoints[i].position.y]);
        }
    }
    return [modelArr, userArr, qualifiedFeatures];
}

function splitInFaceLegsTorso(featuresArr, qualifiedArr){
    let faceFeatures = [];
    let torsoFeatures = [];
    let legsFeatures = [];

    for(var i=0; i<qualifiedArr.length; i++){
        if(faceFeatureList.includes(qualifiedArr[i])){
            faceFeatures.push(featuresArr[i]);
        }else if(torsoFeatureList.includes(qualifiedArr[i])){
            torsoFeatures.push(featuresArr[i]);
        }else if(legsFeatureList.includes(qualifiedArr[i])){
            legsFeatures.push(featuresArr[i]);
        }
    }

    return [faceFeatures, torsoFeatures, legsFeatures];
}

function affineTransformation(modelFeatures, userFeatures){
    // Handle empty features
    if(userFeatures.length < 1){
        return [[], Math.PI];
    }

    let sx = 1;
    let sy = 1;
    let tx = 0;
    let ty = 0;
    let theta = 0;

    let lr = 0.001;
    let n = userFeatures.length;
    let sumErr = 100;
    
    for(var j=0; j<1000; j++) {
    	// least square error
    	let sumErrX = 0;
    	let sumErrY = 0;
        
        
        let sxGrad = 0;
        let syGrad = 0;
        let txGrad = 0;
        let tyGrad = 0;
        let thetaGrad = 0;

        for(var i=0; i<n; i++){
            let errX = sx * Math.cos(theta) * userFeatures[i][0] - sy * Math.sin(theta) * userFeatures[i][1] + tx - modelFeatures[i][0];
            let errY = sx * Math.sin(theta) * userFeatures[i][0] + sy * Math.cos(theta) * userFeatures[i][1] + ty - modelFeatures[i][1];

            sumErrX += Math.pow(errX, 2);
            sumErrY += Math.pow(errY, 2);

            sxGrad += (Math.cos(theta) + Math.sin(theta)) * userFeatures[i][0] * (errX + errY);
            syGrad += (Math.cos(theta) - Math.sin(theta)) * userFeatures[i][1] * (errX + errY);
            txGrad += errX;
            tyGrad += errY;
            thetaGrad += (sx * userFeatures[i][0] * Math.cos(theta) - sy * userFeatures[i][1] * Math.sin(theta)) * errY -
            (sx * userFeatures[i][0] * Math.sin(theta) + sy * userFeatures[i][1] * Math.cos(theta)) * errX;
        }
        
        if(Math.abs(sumErr - (sumErrX + sumErrY)) < 0.0001) {
        	break;
       	}

        sumErr = sumErrX + sumErrY;
        
        if(sumErr < 0.001){
        	break;
        }

        sx -= lr * sxGrad;
        sy -= lr * syGrad;
        tx -= lr * txGrad;
        ty -= lr * tyGrad;
        theta -= lr * thetaGrad;
    }
    
    let affMatrix = compose(
        translate(tx, ty),
        rotate(theta),
        scale(sx, sy)
    );

    let transformedFeatures = applyToPoints(affMatrix, userFeatures);
    return [transformedFeatures, [sx, sy, theta, tx, ty]];
}

function maxDistanceAndRotation(modelFeatures, transformedFeatures, A){
    let sx = A[0];
    let sy = A[1];
    let theta = A[2];

    if(transformedFeatures.length < 1 || sx < 0 || sy < 0){
        return [1, 1, 1]; // set distance and rotations to max
    }

    // Max Euclidean Distance
    let maxDist = 0;
    let totalDist = 0;

    for(var i=0; i < modelFeatures.length; i++){
        let dist = Math.sqrt(Math.pow((modelFeatures[i][0] - transformedFeatures[i][0]), 2) + 
        Math.pow((modelFeatures[i][1] - transformedFeatures[i][1]), 2));

        totalDist += dist;

        if(dist > maxDist){
            maxDist = dist;
        }
    }

    let avgDist = totalDist / modelFeatures.length;

    // Rotations
    let rotations = Math.abs((theta * 180 / Math.PI) % 360) ;
    if (rotations > 180) {
        rotations -= 180;
    }
    rotations /= 180; // scale rotations 0 to 1

    return [maxDist, avgDist, rotations];
}

function getSimilarityScore(maxDistances, avgDistances, rotations){
    maxScore = 100;

    let faceScore = maxScore - (maxDistances.face + rotations.face) * 50;
    let torsoScore = maxScore - (maxDistances.torso + rotations.torso) * 50;
    let legsScore = maxScore - (maxDistances.legs + rotations.legs) * 50;

    return [faceScore, torsoScore, legsScore];
}

function getSimilarity(modelFeaturesObj, userFeaturesObj) {
    // remove unqualified features
    let [modelFeatures, userFeatures, qualifiedFeatures] = removeUnqualifiedKeypoints(modelFeaturesObj, userFeaturesObj);

    // check qualified features threshold
    if(qualifiedFeatures.length < minFeaturesThreshold){
        return false;
    }

    // standardize features
    let modelFeaturesScaled = standardization(modelFeatures);
    let userFeaturesScaled = standardization(userFeatures)

    // split features in 3 parts
    let [modelFace, modelTorso, modelLegs] = splitInFaceLegsTorso(modelFeaturesScaled, qualifiedFeatures);
    let [userFace, userTorso, userLegs] = splitInFaceLegsTorso(userFeaturesScaled, qualifiedFeatures);

    // affine transformation
    let [transformedFace, AFace] = affineTransformation(modelFace, userFace);
    let [transformedTorso, ATorso] = affineTransformation(modelTorso, userTorso);
    let [transformedLegs, ALegs] = affineTransformation(modelLegs, userLegs);

    // max distance and rotations
    let [maxDistFace, avgDistFace, rotationFace] = maxDistanceAndRotation(modelFace, transformedFace, AFace);
    let [maxDistTorso, avgDistTorso, rotationTorso] = maxDistanceAndRotation(modelTorso, transformedTorso, ATorso);
    let [maxDistLegs, avgDistLegs, rotationLegs] = maxDistanceAndRotation(modelLegs, transformedLegs, ALegs);

    let maxDistances = {
        face: maxDistFace,
        torso: maxDistTorso,
        legs: maxDistLegs
    }

    let avgDistances = {
        face: avgDistFace,
        torso: avgDistTorso,
        legs: avgDistLegs
    }

    let rotations = {
        face: rotationFace,
        torso: rotationTorso,
        legs: rotationLegs
    }

    // similarity score
    let [faceScore, torsoScore, legsScore] = getSimilarityScore(maxDistances, avgDistances, rotations);
    let totalScore = 0.2*faceScore + 0.4*torsoScore + 0.4*legsScore;

    document.getElementById("face").innerHTML = faceScore;
    document.getElementById("torso").innerHTML = torsoScore;
    document.getElementById("legs").innerHTML = legsScore;
    document.getElementById("total").innerHTML = totalScore;

    if(totalScore >= 90){
        return true;
    }
    return false;
}

function setExampleImage() {
  // get example
  example = data.cqcw[idx];
  exFilename = example.filename;
  // exResult = example.result;
  imgObj = document.getElementById("img-example");
  imgObj.src = exFilename;
  exPoseData = {
    score: example.pose.score,
    keypoints: example.pose.keypoints
  };
}

function setup() {
  setExampleImage();

  createCanvas(600, 600);
  video = createCapture(VIDEO);
  video.size(width, height);

  // Create a new poseNet method with a single detection
  poseNet = ml5.poseNet(video, options, modelReady);
  
  // This sets up an event that fills the global variable "poses"
  // with an array every time new poses are detected
  poseNet.on('pose', function(results) {
    poses = results;
    if(poses && poses.length > 0) {
      userPoseData = {
        score: poses[0].pose.score,
        keypoints: poses[0].pose.keypoints
      };
      isSimilar = getSimilarity(exPoseData, userPoseData);
    }
  });
  // Hide the video element, and just show the canvas
  video.hide();
}

function modelReady() {
  select('#status').html('Model Loaded');
}

function draw() {
  image(video, 0, 0, width, height);

  // We can call both functions to draw all keypoints and the skeletons
  drawKeypoints();
  drawSkeleton();

  if(isSimilar) {
    alert("Congratulations!!");
    if(idx == data.length - 1){
      idx = 0;
    }else{
      idx++;
    }
    isSimilar = !isSimilar;
    setExampleImage();
  }
}

// A function to draw ellipses over the detected keypoints
function drawKeypoints()  {
  // Loop through all the poses detected
  for (let i = 0; i < poses.length; i++) {
    // For each pose detected, loop through all the keypoints
    let pose = poses[i].pose;
    for (let j = 0; j < pose.keypoints.length; j++) {
      // A keypoint is an object describing a body part (like rightArm or leftShoulder)
      let keypoint = pose.keypoints[j];
      // Only draw an ellipse is the pose probability is bigger than 0.2
      if (keypoint.score > 0.2) {
        fill(255, 0, 0);
        noStroke();
        ellipse(keypoint.position.x, keypoint.position.y, 10, 10);
      }
    }
  }
}

// A function to draw the skeletons
function drawSkeleton() {
  // Loop through all the skeletons detected
  for (let i = 0; i < poses.length; i++) {
    let skeleton = poses[i].skeleton;
    // For every skeleton, loop through all body connections
    for (let j = 0; j < skeleton.length; j++) {
      let partA = skeleton[j][0];
      let partB = skeleton[j][1];
      stroke(255, 0, 0);
      line(partA.position.x, partA.position.y, partB.position.x, partB.position.y);
    }
  }
}